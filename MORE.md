# Мысли вслух

## Пагинация

1. В пагинации сортировка "ins_ts,id" но нет индекса, базы это умеют обычно
2. Чем дальше по страницам - тем дольше, случайно нажатая последняя страница может стать проблемой
   Решение: ограничить глубину истории; ввести фильтры по дате; добавить условие выборки на id
   (но придется убрать поддержку перехода на произвольную страницу).
3. count(*) больно. Решение: пагинация на +1-2 страницы вперед, т.е. не выводить номера последних страниц;
   если мы предполагаем монотонность id без пробелов - брать max(id)

## Экспорт

Такие же проблемы, что и в пагинации. Экспорт использует батчи, которые так же на OFFSET-ах.

Вообще экспорт больших данных в режиме "запросили и отдали" возможен только
если мы точно знаем, что условия выборки настолько строги, что будет выдано небольшое
число строк без использования пагинации. И даже в таком случае стоит добавить кеширование
результата.

Для больших отчетов нужно начинать двигаться другим путем
- генерирование в фоновом режиме отдельными воркерами с батчами на базе смещения id, выдача ссылки по готовности
- генерирование сложных отчетов с использованием аналитических баз
- для переодических отчетов - превентивное генерирование отчета

## Связи с объектами

В данном решении получается, что Yii пытается выбрать все object_id из каждой таблицы объектов.
Как результат - он будет подтягивать, например сущность SMS c id=555 тогда как нужна Call с тем же
id (которую он тоже подтянет). Оверхед в целом не очень большой, но, имхо, не очень приятный.

Решил эту проблему переопределив findWith и делая populateRelation над сабсетами моделей. 
[Комит](https://github.com/miksir/americor/pull/1/commits/fc0406cb2641ad2067062c47b8d8d8b0036da06d)

